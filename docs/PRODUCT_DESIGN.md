# VoicePilot-Eino 产品设计文档

## 目录
1. [功能需求与优先级规划](#1-功能需求与优先级规划)
2. [实现挑战与应对策略](#2-实现挑战与应对策略)
3. [LLM 模型选型分析](#3-llm-模型选型分析)
4. [未来功能规划](#4-未来功能规划)

---

## 1. 功能需求与优先级规划

### 1.1 核心功能需求

基于语音助手的本质定位，VoicePilot-Eino 需要以下核心功能：

#### P0 级功能（必须实现，已完成）

| 功能模块 | 功能描述 | 技术实现 | 状态 |
|---------|---------|---------|------|
| **语音识别（ASR）** | 将用户语音转换为文本 | 七牛云 ASR API，双策略（WebSocket + HTTP降级） | ✅ 已完成 |
| **意图理解** | 解析用户输入，识别意图和参数 | 基于 LLM 的结构化输出 | ✅ 已完成 |
| **任务规划** | 将意图转换为可执行的任务计划 | LLM 生成 JSON 格式任务步骤 | ✅ 已完成 |
| **安全检查** | 防止危险命令执行 | 白名单机制 + 参数验证 | ✅ 已完成 |
| **任务执行** | 执行系统级操作 | 系统命令调用、应用集成 | ✅ 已完成 |
| **响应生成** | 生成自然语言响应 | LLM 生成友好回复 | ✅ 已完成 |
| **语音合成（TTS）** | 将文本响应转换为语音 | 七牛云 TTS API | ✅ 已完成 |

**已实现的具体操作：**
- ✅ 打开应用程序（跨平台支持 macOS/Windows/Linux）
- ✅ 播放音乐（网易云音乐集成，AppleScript 自动化）
- ✅ 执行系统命令
- ✅ AI 文本生成（写文章、生成内容等）
- ✅ 多轮对话澄清机制

#### P1 级功能（重要但非核心，部分完成）

| 功能模块 | 功能描述 | 优先级理由 | 状态 |
|---------|---------|-----------|------|
| **多轮对话管理** | 维护对话上下文，支持连续对话 | 提升用户体验，实现复杂交互 | ⚠️ 部分实现（有 session_id 但未持久化） |
| **文件操作** | 读取、保存、搜索文件 | 常见办公场景需求 | ⏸️ 计划中 |
| **网页浏览** | 打开网页、搜索信息 | 扩展信息获取能力 | ⏸️ 计划中 |
| **日程管理** | 添加提醒、查看日历 | 个人助理核心功能 | ⏸️ 计划中 |

#### P2 级功能（增强功能，未开始）

| 功能模块 | 功能描述 | 优先级理由 | 状态 |
|---------|---------|-----------|------|
| **个性化设置** | 自定义唤醒词、音色、快捷指令 | 提升个性化体验 | ⏸️ 计划中 |
| **插件系统** | 支持第三方插件扩展 | 生态建设 | ⏸️ 计划中 |
| **多设备同步** | 跨设备共享对话历史和设置 | 多场景使用 | ⏸️ 计划中 |
| **情感分析** | 识别用户情绪，调整响应风格 | 提升交互自然度 | ⏸️ 计划中 |

### 1.2 本次开发完成的功能

**第一阶段（已完成）：**

1. **完整的 7 节点工作流**
   - ASR Node：语音转文本（双策略实现）
   - Intent Node：意图识别
   - Planner Node：任务规划
   - Security Node：安全检查
   - Executor Node：任务执行
   - Response Node：响应生成
   - TTS Node：语音合成

2. **核心执行器功能**
   - 应用程序启动（跨平台）
   - 音乐播放（网易云音乐深度集成）
   - 系统命令执行
   - AI 文本生成

3. **关键技术实现**
   - AppleScript 自动化（macOS）
   - 中文字符输入解决方案（剪贴板方法）
   - WebSocket + HTTP 双策略 ASR
   - 结构化意图输出（JSON Schema）

4. **完善的基础设施**
   - HTTP REST API 服务
   - Web 界面（音频上传、文本交互）
   - 测试套件（API、ASR、七牛云集成）
   - 完整的错误处理和日志记录

---

## 2. 实现挑战与应对策略

### 2.1 核心技术挑战

#### 挑战 1：语音识别准确性

**问题描述：**
- 环境噪音干扰识别准确率
- 方言、口音导致识别错误
- 网络不稳定影响实时性

**应对策略：**

✅ **已实现：**
- 双策略 ASR 实现：WebSocket 实时识别 + HTTP API 降级
- 置信度阈值检查：低置信度时触发"请重复"
- 错误处理机制：优雅降级而非直接失败

🔄 **未来优化：**
- 增加本地降噪预处理
- 支持用户训练个性化语音模型
- 引入多模型投票机制（同时调用多个 ASR 服务，取最佳结果）

#### 挑战 2：意图理解的准确性和稳定性

**问题描述：**
- LLM 输出不稳定，可能不符合预期 JSON 格式
- 复杂意图或模糊表达难以解析
- 多义性处理（如"打开音乐"可能指打开应用或播放歌曲）

**应对策略：**

✅ **已实现：**
- 结构化 Prompt 工程：明确要求输出 JSON 格式
- JSON 解析容错：解析失败时使用 fallback 机制
- 低置信度澄清：confidence < 0.5 时要求用户重新表述

🔄 **未来优化：**
- Few-shot 示例：在 Prompt 中加入示例输入输出
- 领域特定微调：针对常见任务微调意图识别
- 多轮确认机制：关键操作前二次确认

#### 挑战 3：安全性控制

**问题描述：**
- 恶意指令注入（如"删除所有文件"）
- 敏感数据泄露风险
- 误操作造成系统损坏

**应对策略：**

✅ **已实现：**
- 白名单机制：只允许预定义的安全操作
- 参数验证：检查命令参数的合法性
- 危险操作拦截：自动替换为错误提示

🔄 **未来优化：**
- 用户权限分级：不同用户拥有不同操作权限
- 操作审计日志：记录所有执行的命令
- 敏感操作二次确认：删除、修改系统设置等需语音确认
- 沙箱执行环境：隔离执行环境防止系统污染

#### 挑战 4：跨平台兼容性

**问题描述：**
- macOS、Windows、Linux 系统调用差异大
- 应用程序名称和启动方式不统一
- 某些功能仅特定平台支持（如 AppleScript）

**应对策略：**

✅ **已实现：**
- runtime.GOOS 检测：根据操作系统选择不同实现
- 网易云音乐双策略：macOS 用本地 app，其他系统用浏览器
- 跨平台应用启动：统一封装 open/start/xdg-open

🔄 **未来优化：**
- 平台适配层：抽象出统一的系统操作接口
- 功能特性检测：运行时检测平台支持的功能
- 优雅降级提示：不支持的功能给出明确说明

#### 挑战 5：多轮对话上下文管理

**问题描述：**
- 需要记住上次对话内容（如"继续写那篇文章"）
- 上下文窗口限制（Token 限制）
- 跨会话状态持久化

**应对策略：**

⚠️ **当前状态：**
- 已有 session_id 机制但未实现持久化
- 单次请求内无上下文关联

🔄 **计划实现：**
- 会话存储：使用 Redis/内存存储会话历史
- 上下文摘要：超过限制时自动压缩历史信息
- 引用消歧：处理指代关系（"它"、"那个"等）
- 时间衰减：旧对话逐渐降低权重

#### 挑战 6：实时性与用户体验

**问题描述：**
- 7 节点串行执行延迟高（ASR + LLM + TTS 总计 3-5 秒）
- 用户等待过程缺少反馈
- 网络波动导致超时

**应对策略：**

✅ **已实现：**
- 异步执行架构：Go 并发处理
- TTS 可选：TTS 失败不影响核心功能

🔄 **未来优化：**
- 流式响应：边生成边播放 TTS
- 中间状态反馈：显示"正在识别"、"正在思考"等
- 并行节点执行：非依赖节点可并行处理
- 本地缓存：常见意图缓存减少 LLM 调用

### 2.2 工程实践挑战

#### 挑战 7：测试覆盖和质量保证

**应对策略：**

✅ **已实现：**
- 单元测试：API 测试脚本
- 集成测试：完整工作流测试
- 真实场景测试：网易云音乐集成测试

🔄 **未来优化：**
- 自动化测试：CI/CD 集成
- 压力测试：并发请求测试
- 边界测试：异常输入处理

---

## 3. LLM 模型选型分析

### 3.1 选型对比

我们对比了以下主流 LLM 服务商：

| 服务商 | 模型 | 优势 | 劣势 | 评分 |
|-------|------|------|------|------|
| **七牛云** | 通义千问/Qwen | ✅ 一站式服务（ASR+LLM+TTS）<br>✅ 国内部署，低延迟<br>✅ 价格实惠<br>✅ 集成简单 | ⚠️ 能力相对弱于 GPT-4<br>⚠️ 社区生态较小 | ⭐⭐⭐⭐ |
| OpenAI | GPT-4/GPT-3.5 | ✅ 能力最强<br>✅ 生态成熟<br>✅ 稳定性高 | ❌ 需要翻墙<br>❌ 延迟高（海外服务器）<br>❌ 价格昂贵<br>❌ 需单独集成 ASR/TTS | ⭐⭐⭐ |
| Anthropic | Claude 3.5 Sonnet | ✅ 推理能力强<br>✅ 上下文窗口大<br>✅ 安全性好 | ❌ 国内访问困难<br>❌ 价格高<br>❌ 需单独集成 ASR/TTS | ⭐⭐⭐ |
| 阿里云 | 通义千问 | ✅ 中文能力强<br>✅ 国内部署<br>✅ 生态完整 | ⚠️ API 复杂度高<br>⚠️ 文档碎片化 | ⭐⭐⭐⭐ |
| 腾讯云 | 混元 | ✅ 一站式服务<br>✅ 国内部署<br>✅ 企业级支持 | ⚠️ 价格较高<br>⚠️ API 设计欠佳 | ⭐⭐⭐ |
| Moonshot | Kimi | ✅ 超长上下文<br>✅ 中文优化<br>✅ 价格适中 | ❌ 无 ASR/TTS<br>⚠️ 初创公司稳定性待验证 | ⭐⭐⭐ |

### 3.2 最终选择：七牛云

**选择理由：**

1. **一站式集成（决定性因素）**
   - ASR + LLM + TTS 三者在同一平台，减少集成复杂度
   - 统一的认证和计费体系
   - 降低跨服务调用延迟

2. **国内部署优势**
   - 低延迟：服务器在国内，平均响应 < 500ms
   - 稳定性：无需考虑墙的问题
   - 合规性：符合国内数据安全法规

3. **成本优势**
   - 价格比 OpenAI 低 60%-80%
   - 提供免费额度
   - 适合个人和初创团队

4. **中文优化**
   - 基于通义千问，中文理解能力优秀
   - 本地化 Prompt 效果好
   - 中文语音识别准确率高

5. **足够的能力**
   - 虽然不如 GPT-4，但对语音助手场景足够
   - 结构化输出稳定（JSON 格式）
   - 推理速度快（重要于准确度的边际提升）

**权衡考虑：**

| 场景 | 是否考虑更换 |
|-----|------------|
| 需要最强推理能力（如复杂数学、编程） | 是 → GPT-4 |
| 需要超长上下文（>100k tokens） | 是 → Kimi/Claude |
| 主要面向海外用户 | 是 → OpenAI/Claude |
| 对成本不敏感 | 是 → GPT-4 |
| **当前场景：语音助手（中文、实时、低成本）** | **否 → 七牛云最优** |

### 3.3 未来模型策略

**多模型架构（计划中）：**

```
意图识别 → 七牛云（快速、便宜）
复杂推理 → GPT-4（必要时调用）
文本生成 → 七牛云（主力）+ GPT-4（质量要求高时）
代码生成 → Claude 3.5（专项任务）
```

**模型切换机制：**
- 根据任务类型自动选择最佳模型
- 支持用户配置偏好（速度优先 vs 质量优先）
- 成本控制：设置每日 API 调用预算

---

## 4. 未来功能规划

### 4.1 短期规划（1-3 个月）

#### 1. 完善多轮对话能力 ⭐⭐⭐⭐⭐

**重要性：** 这是从"工具"到"助手"的关键跃迁

**功能细节：**
- 会话历史存储（Redis/SQLite）
- 上下文引用理解（"继续写"、"再播放一首"）
- 对话摘要机制（压缩历史避免 Token 超限）
- 跨会话恢复（"上次我们说到哪了？"）

**技术方案：**
```go
type ConversationStore struct {
    History map[string][]Message  // sessionID -> messages
    Summary map[string]string     // sessionID -> summary
}

// 每次请求注入最近 5 轮对话
func (w *Workflow) injectContext(sessionID string, currentText string) []Message {
    history := w.store.GetRecent(sessionID, 5)
    return append(history, Message{Role: "user", Content: currentText})
}
```

**为何重要：**
- 用户体验质的飞跃：从单次问答到连续对话
- 解锁复杂任务：分步骤完成需要多轮确认的任务
- 个性化基础：积累用户偏好数据

#### 2. 文件操作能力 ⭐⭐⭐⭐

**功能细节：**
- 读取文件内容（"帮我总结这个文档"）
- 保存生成内容（"把刚才的文章保存到桌面"）
- 文件搜索（"找一下我昨天写的报告"）
- 文件对比（"对比这两个版本"）

**安全考虑：**
- 限制可访问目录（用户主目录、文档目录）
- 文件大小限制（避免读取大文件导致超时）
- 敏感文件黑名单（.ssh、.env 等）

**为何重要：**
- 办公场景核心需求
- 与 AI 文本生成功能协同（生成+保存）

#### 3. 网页浏览集成 ⭐⭐⭐⭐

**功能细节：**
- 打开指定网页（"打开百度"）
- 搜索信息（"搜索今天的天气"）
- 网页内容提取（"这个网页讲了什么？"）
- 在线翻译（"把这段话翻译成英文"）

**技术方案：**
- 使用 chromedp 或 selenium 实现浏览器自动化
- 内容提取用 LLM 进行摘要

**为何重要：**
- 信息获取是助手的基本能力
- 打通线上线下（本地操作+网络信息）

### 4.2 中期规划（3-6 个月）

#### 4. 个性化与用户画像 ⭐⭐⭐⭐

**功能细节：**
- 学习用户偏好（常用应用、音乐偏好、工作习惯）
- 自定义快捷指令（"早安模式"→打开邮箱+播放新闻）
- 自适应响应风格（正式/轻松）
- 主动提醒（"您通常这个时间会开会，需要提醒吗？"）

**技术方案：**
```go
type UserProfile struct {
    UserID           string
    FrequentApps     []string          // 常用应用
    MusicPreference  map[string]int    // 歌曲偏好
    WorkPattern      TimePattern       // 工作时间规律
    ResponseStyle    string            // 响应风格
    CustomCommands   map[string]Action // 自定义指令
}
```

**为何重要：**
- 从通用助手到专属助手
- 提升效率（减少重复输入）
- 增强用户粘性

#### 5. 插件与扩展系统 ⭐⭐⭐⭐⭐

**功能细节：**
- 插件 API：第三方开发者可编写插件
- 插件市场：用户可安装/卸载插件
- 安全沙箱：插件运行在隔离环境
- 标准化接口：统一的输入输出格式

**示例插件：**
- Notion 集成（"在 Notion 里新建笔记"）
- GitHub 集成（"查看我的仓库 issues"）
- 邮件集成（"发邮件给张三"）
- 智能家居控制（"打开客厅灯"）

**技术架构：**
```go
type Plugin interface {
    Name() string
    Execute(ctx context.Context, params map[string]interface{}) (*Result, error)
    Capabilities() []Capability
}

// 插件注册
func (e *Executor) RegisterPlugin(plugin Plugin) {
    e.plugins[plugin.Name()] = plugin
}
```

**为何重要：**
- 生态建设的基石
- 无限扩展能力（官方不可能覆盖所有场景）
- 社区驱动发展

#### 6. 情感识别与情境感知 ⭐⭐⭐

**功能细节：**
- 语音情感分析（检测用户情绪：开心/沮丧/愤怒）
- 时间情境感知（早上问候"早上好"，晚上说"辛苦了"）
- 任务紧急度判断（"赶紧"→优先执行）
- 调整响应风格（用户沮丧时更温柔）

**技术方案：**
- 使用情感分析 API（如声纹分析）
- LLM Prompt 注入情境信息
- 多模态融合（语音 + 语义）

**为何重要：**
- 拟人化体验
- 更自然的交互
- 情感连接（不只是工具，更像伙伴）

### 4.3 长期愿景（6-12 个月）

#### 7. 主动式助手 ⭐⭐⭐⭐⭐

**从"被动响应"到"主动服务"：**

**功能设想：**
- 日程提醒：自动分析邮件和日历，提前提醒
- 任务预测：根据历史习惯主动建议（"该写周报了"）
- 智能总结：每天结束时总结当天工作
- 异常检测：发现异常模式并提醒（"您今天没有开晨会"）

**技术挑战：**
- 如何不打扰用户（Timing 很关键）
- 如何提高预测准确率（需要大量用户数据）
- 隐私与主动性的平衡

**为何重要：**
- 这是 AI 助手的终极形态
- 从"工具"进化为"伙伴"
- 真正意义上的"智能"

#### 8. 多设备协同 ⭐⭐⭐⭐

**功能细节：**
- 手机/电脑/智能音箱无缝切换
- 对话历史云同步
- 任务跨设备继续（手机开始，电脑完成）
- 设备间协作（"把手机上的照片发到电脑"）

**技术方案：**
- 云端会话存储
- WebSocket 推送
- 设备绑定与认证

**为何重要：**
- 全场景覆盖
- 用户无需重复交代上下文
- 移动时代的必然需求

#### 9. 企业级能力 ⭐⭐⭐

**功能细节：**
- 多用户管理
- 权限分级
- 审计日志
- 私有化部署
- 企业知识库集成

**为何重要：**
- 商业化路径
- 2B 市场更大
- 企业付费意愿强

### 4.4 功能优先级总结

| 优先级 | 功能 | 时间线 | 重要性理由 |
|-------|------|-------|-----------|
| 🔥🔥🔥🔥🔥 | 多轮对话 | 1 个月 | 用户体验质变，解锁复杂任务 |
| 🔥🔥🔥🔥 | 文件操作 | 2 个月 | 办公场景核心需求 |
| 🔥🔥🔥🔥 | 网页集成 | 2 个月 | 信息获取基础能力 |
| 🔥🔥🔥🔥 | 个性化 | 3 个月 | 从通用到专属 |
| 🔥🔥🔥🔥🔥 | 插件系统 | 4 个月 | 生态建设，可持续发展 |
| 🔥🔥🔥 | 情感识别 | 5 个月 | 拟人化体验 |
| 🔥🔥🔥🔥🔥 | 主动助手 | 9 个月 | 终极形态 |
| 🔥🔥🔥🔥 | 多设备协同 | 10 个月 | 全场景覆盖 |
| 🔥🔥🔥 | 企业级 | 12 个月 | 商业化 |

---

## 5. 总结

### 5.1 产品定位

VoicePilot-Eino 是一个**开源、模块化、可扩展的语音控制桌面助手**，旨在：

1. 通过语音简化电脑操作
2. 集成 AI 能力提升生产力
3. 提供插件化架构支持社区扩展
4. 保持隐私优先和安全可控

### 5.2 核心竞争力

- ✅ **技术栈现代化**：Go + Workflow 架构
- ✅ **安全性优先**：白名单机制 + 沙箱执行
- ✅ **中文优化**：国内 LLM 服务 + 本地化
- ✅ **可扩展性**：模块化设计 + 未来插件系统
- ✅ **开源透明**：代码开放，隐私可控

### 5.3 成功指标

**技术指标：**
- 语音识别准确率 > 95%
- 意图理解准确率 > 90%
- 端到端延迟 < 3 秒
- 系统可用性 > 99.9%

**用户指标：**
- 日活跃用户数
- 平均每日交互次数
- 功能使用分布
- 用户留存率（D7/D30）

**生态指标：**
- 社区贡献者数量
- 第三方插件数量
- GitHub Stars/Forks

---

**文档版本：** v1.0
**最后更新：** 2025-10-22
**作者：** VoicePilot-Eino 团队
